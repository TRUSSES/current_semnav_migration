# Reactive Navigation with Semantic Feedback Using ROS2

This package has been adapted from [vvasilo/semnav](https://github.com/vvasilo/semnav). Please refer to the original repository for relevant publications, citations, and additional info.

This has been tested with Ubuntu 22.04 and ROS2 Humble, using a Turtlebot3 Waffle (differential drive) model in Gazebo 11.

>**Branch in use**: `neha` (for simulation and testing)

## Components
1. Navigation node (`navigation.cpp`): Uses semantic map as input, runs the planning algorithm, and publishes Twist commands.
2. Fake map publisher for simulation (`map_debug.cpp`).
3. Trajectory recorder node to be started and stopped while the simulation is running (`trajectory_recorder.py`).

## Setup Instructions

### 1. ROS2 + Dependencies

- Install **ROS2 Humble**: [Create a ROS2 Workspace (Humble)](https://docs.ros.org/en/humble/Tutorials/Beginner-Client-Libraries/Creating-A-Workspace/Creating-A-Workspace.html)
- Install dependencies from the original repo: Boost Geometry, CGAL, earcut.hpp, trippy, shapely, scipy, numpy, matplotlib, imagemagick
- Clone this repo into your `~/ros2_ws/src` workspace.
- Copy custom messsage definitions: `cp -r extras/object_pose_interface_msgs ~/ros2_ws/src/`
- Source environment: `source ~/ros2_ws/src/install/setup.bash`
- Build packages:
```
cd ~/ros2_ws/src
colcon build --packages-select object_pose_interface_msgs semnav
```
- Check installation: `ros2 pkg list | grep -e semnav -e object`

### 2. Gazebo + TurtleBot3 Setup

- Install Gazebo 11, possibly from source since this is not the default version.
- Install [TurtleBot3 (ROS2 Humble)](https://emanual.robotis.com/docs/en/platform/turtlebot3/quick-start/)
- Add environment variable: `export TURTLEBOT3_MODEL=waffle`

## Simulation Instructions

### 1. Polygon Map Setup
- Store your obstacle CSV file in `~/ros2_ws/src/current_semnav_migration/data/` with the following format:
    - First row: X coordinates of each polygon.
    - Second row: Y coordinates of each polygon.
    - Polygons separated by `NaN`
    - First polygon represents the workspace boundary, and is ignored when generating the map.

- Functions used in `map.debug.cpp`:
    - `get_polygons()`: Parses polygons from CSV
    - `generate_sdf()`: Generates the SDF model, where obstacles are visual only (no collision properties)
 
### 2. Launch semnav navigation nodes.

#### Launch file functions
- Read and parse polygon CSV.
- Publish semantic map of polygons.
- Publish fake LIDAR data.
- Set parameters for the planning algorithm and run the navigation node.

#### Arguments
- `obstacle_file`: name of obstacle file CSV (must be stored in `/data/`).
- (Optional) Change `Goal_x` and `Goal_y` coordinates directly in the launch file for now.

Example usage:
```
ros2 launch semnav sim_navigation_turtlebot3.launch.py \
    obstacle_file:="1x1rect.csv"
```

### 3. Launch TurtleBot3 Simulation

#### Launch file functions
- Load the polygon world SDF file generated by `sim_navigation_turtlebot3.launch.py`.
- Spawn the TurtleBot at a specified location.
- Start other necessary nodes for Gazebo.

#### Arguments
- `x_pose`: X coordinate of TurtleBot starting position.
- `y_pose`: Y coordinate of TurtleBot starting position.
- `gui`: false to turn GUI off (run Gazebo headless), true to turn GUI on.

Example usage:
```
ros2 launch semnav turtlebot3_polygon_world.launch.py \
    x_pose:=[start_x] y_pose:=[start_y] gui:=0
```

### 4. Record Trajectories
This node captures the robot’s real-time pose during simulation and saves it to a CSV file.

#### Functions
- Records the robot’s pose while the navigation and Gazebo nodes are running.
- Saves output to the ROS2 share directory, e.g.
```
/home/[user]/ros2_ws/src/install/semnav/share/semnav/data/`
```
- Stops recording with `CTRL-C`.

#### Argument
- `output_file`: name of the CSV file to store poses (will be created in the share directory).

Example usage:
```
ros2 run semnav trajectory_recorder.py \
    --ros-args -p output_file:="1x1trajectory0.csv"
```

### 5. Trajectory and Obstacle Map Visualization.
This script plots recorded robot trajectories over a semantic obstacle map.

Required Python packages: `matplotlib, pandas, numpy`.

Edit the script:
- Open `/data/scripts/plot_trajectory.py`.
- Hardcode the absolute path of your `semnav` share directory in the script.

#### Arguments
- `--title`: Title of plot. (string)
- `--obstacle_file`: CSV file in `/data` that contains polygonal obstacle data. (string)
- `--goal_x`: X coordinate of goal. (float)
- `--goal_y`: Y coordinate of goal. (float)
- `--pattern`: Unix shell-style wildcard pattern for which trajectory files to visualize. (string)
    - Should correspond to the output file specified in the trajectory recorder node.
    - Default is to match all files named `trajectory*.csv`.

Example usage:
```
python3 plot_trajectory.py \
    --title="2x2 obstacle trajectories" \
    --obstacle_file="rect.csv" \
    --goal_x=4.0 \
    --goal_y=-1.0 \
    --pattern="2x2trajectory*csv"
```

### Debugging Tips
- Use `ros2 topic list` to confirm semnav topics are running.
- Rebuild after code changes, source correctly in every terminal.
- If Gazebo isn't refreshing: `killall -9 gzserver gzclient`.
- Ensure you're using the correct share directory for CSV I/O.
